# クエスト報酬付与失敗時のリトライ方法

`QuestProgressHandler` では、クエスト完了時に `_grant_reward` で報酬を付与しています。  
**推奨方針（A）を実装済み**です: 付与に失敗したら `QuestRewardGrantException` を投げ、ハンドラはその例外をそのまま再送出するため、イベント配送層（キュー等）のリトライに載せられます。

---

## 1. 実装済み: 失敗時に例外を投げる + イベント再配送（A）

- **例外**: `QuestRewardGrantException`（`application.quest.exceptions`）  
  - 受託者の `PlayerStatus` / `PlayerInventory` が存在しない  
  - プレイヤー発行時で発行者のインベントリが存在しない  
  - システム報酬の `ItemSpec` が存在しない  
  のいずれかのときに投げられます。`quest_id` / `acceptor_player_id` をコンテキストに持つため、ログ・監視に利用できます。
- **ハンドラ**: `QuestProgressHandler.handle` および `_execute_in_separate_transaction` で  
  `ApplicationException` / `DomainException` に加え **`QuestApplicationException`**（`QuestRewardGrantException` の基底）を再送出するため、配送層まで例外が伝播します。
- **トランザクション**: 報酬付与で例外が発生すると `save(quest)` まで到達しないため、完了状態は保存されません。再配送時に同じイベントで再度進捗→完了→報酬付与が試行されます。

**イベント配送側でのリトライ:**

- 同期的にイベントを配送している場合: 呼び出し元で `MonsterDiedEvent` 処理が `QuestRewardGrantException` で失敗したら、一定時間後に再度 `handle(event)` を呼ぶ。
- 非同期キュー（Celery / SQS 等）の場合: タスクが例外で失敗するとキューが自動でリトライするため、**例外を投げるだけでリトライがかかります**。リトライ回数・間隔はキュー／ワーカーの設定で制御してください。

---

## 2. その他の方針（参考）

- **B. ハンドラ内でリトライ（指数バックオフ等）**  
  同一ハンドラ内で数回だけ再実行する。一時的な DB 不調向け。A では足りない場合に検討。
- **C. 失敗を記録して別ジョブで補正**  
  報酬付与失敗を「未付与」として永続化し、バッチや別ワーカーで後から付与する。

---

## 3. ハンドラ内でリトライする場合（B）

一時的な障害（DB 負荷・ロック）向けに、ハンドラ内で数回だけリトライする例です。

```python
# 疑似コード
def _grant_reward_with_retry(self, quest, max_attempts: int = 3) -> None:
    for attempt in range(max_attempts):
        try:
            self._grant_reward(quest)
            return
        except TemporaryError as e:  # リトライ対象の例外のみ
            if attempt == max_attempts - 1:
                raise
            time.sleep(2 ** attempt)  # 指数バックオフ
```

- **リトライ対象**  
  - タイムアウト・デッドロック・接続断など「一時的」と判断できる例外だけをキャッチする。  
  - 「プレイヤーが存在しない」など業務エラーはリトライしない（例外のまま伝播させる）。
- **冪等性**  
  `_grant_reward` が複数回呼ばれても問題ないようにする（既に付与済みならスキップする等）。  
  現状の `_grant_reward` は「クエストは既に complete 済み」の前提なので、同じクエストで複数回呼ぶと二重付与になり得る。  
  リトライする場合は「このクエストは報酬付与済みか」をフラグや別テーブルで管理するか、付与処理を冪等にする必要がある。

---

## 4. 失敗を記録して後から補正する場合（C）

- 報酬付与に失敗したら例外は投げず、**「クエスト ID・受託者 ID・付与すべき報酬」を「未付与キュー」や DB に書き込む**。
- 別のバッチ／ワーカーが定期的に未付与一覧を読んで、再度付与を試みる。
- メリット: イベント再配送に依存せず、負荷を分散できる。  
- デメリット: 未付与テーブル・ジョブの設計と運用が必要。

---

## 5. まとめ

- **推奨方針（A）は実装済み**です。報酬付与に失敗したら `QuestRewardGrantException` が投げられ、ハンドラはそのまま再送出するため、イベント再試行やキューのリトライにそのまま載せられます。
- リトライ回数・間隔はイベント配送層やキュー設定で制御し、ハンドラは「失敗したら例外」にしておく責務分離になっています。
- ハンドラ内リトライ（B）や未付与キュー（C）は、A では足りない場合（例: キュー側のリトライが使えない・後からまとめて補正したい）に検討するとよいです。
